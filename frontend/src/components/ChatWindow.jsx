import React,{useState,useEffect,useRef}from'react';import{motion}from'framer-motion';import{useSocket}from'../hooks/useSocket';import{useChat}from'../hooks/useChat';import{useAuth}from'../hooks/useAuth';import{ANIMATIONS}from'../utils/animations';const ChatWindow=()=>{const{socket}=useSocket();const{auth}=useAuth();const{messages,sendMessage,receiveMessage}=useChat();const[input,setInput]=useState('');const[isTyping,setIsTyping]=useState(false);const[activeUsers,setActiveUsers]=useState([]);const[selectedUser,setSelectedUser]=useState(null);const messagesEndRef=useRef(null);const inputRef=useRef(null);const typingTimeoutRef=useRef(null);useEffect(()=>{if(messagesEndRef.current){messagesEndRef.current.scrollIntoView({behavior:'smooth'});}},[ messages]);useEffect(()=>{socket?.on('users-list',(users)=>setActiveUsers(users));socket?.on('typing',(data)=>setIsTyping(true));socket?.on('stop-typing',()=>setIsTyping(false));return()=>{socket?.off('users-list');socket?.off('typing');socket?.off('stop-typing');};},[socket]);const handleSendMessage=()=>{if(input.trim()){const messageData={text:input,sender:auth?.user?.id,senderName:auth?.user?.name,timestamp:new Date(),readBy:[auth?.user?.id]};sendMessage(messageData);socket?.emit('message',messageData);setInput('');if(typingTimeoutRef.current)clearTimeout(typingTimeoutRef.current);socket?.emit('stop-typing');}};const handleTyping=(e)=>{setInput(e.target.value);socket?.emit('typing',{user:auth?.user?.name});if(typingTimeoutRef.current)clearTimeout(typingTimeoutRef.current);typingTimeoutRef.current=setTimeout(()=>{socket?.emit('stop-typing');},1500);};const handleKeyPress=(e)=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();handleSendMessage();}};return(<motion.div initial={{opacity:0,y:20}}animate={{opacity:1,y:0}}transition={{duration:.5}}className="h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 flex gap-4 p-4 md:p-6 lg:p-8 max-w-7xl mx-auto"style={{perspective:'1000px'}}"><motion.div initial={{x:-100,opacity:0}}animate={{x:0,opacity:1}}transition={{delay:.2,duration:.6}}className="hidden md:flex flex-col w-64 bg-slate-800/50 backdrop-blur-xl rounded-2xl border border-purple-500/20 overflow-hidden hover:border-purple-500/40 transition-all duration-300" style={{transform:'rotateY(-5deg)',transformStyle:'preserve-3d'}}"><div className="p-4 bg-gradient-to-r from-purple-600/20 to-cyan-600/20 border-b border-purple-500/20"><h2 className="text-white font-bold text-lg">Active Users</h2></div><div className="flex-1 overflow-y-auto scrollbar-hide"><motion.div variants={ANIMATIONS.container}initial="hidden"animate="show"><motion.div variants={ANIMATIONS.item}className="w-full p-3 text-center border-b border-purple-500/10"><span className="text-xs text-purple-300 font-semibold">{activeUsers.length} online</span></motion.div>{activeUsers.map((user,idx)=>(<motion.div key={`${user.id}-${idx}`}variants={ANIMATIONS.item}onClick={()=>setSelectedUser(user)}className={`p-3 cursor-pointer border-b border-purple-500/10 transition-all duration-300 ${selectedUser?.id===user.id?'bg-purple-600/30 border-l-4 border-l-cyan-400':'hover:bg-purple-600/10'}`}"><div className="flex items-center gap-2"><div className="w-8 h-8 rounded-full bg-gradient-to-br from-cyan-400 to-purple-500 flex items-center justify-center text-xs font-bold text-white">{user.name?.[0]?.toUpperCase()}</div><div className="text-left flex-1 min-w-0"><p className="text-sm text-white font-medium truncate">{user.name}</p><p className="text-xs text-green-400">â— online</p></div></div></motion.div>))}</motion.div></div></motion.div><motion.div initial={{opacity:0,scale:.95}}animate={{opacity:1,scale:1}}transition={{delay:.3,duration:.6}}className="flex-1 flex flex-col bg-slate-800/50 backdrop-blur-xl rounded-2xl border border-purple-500/20 overflow-hidden hover:border-purple-500/40 transition-all duration-300" style={{transform:'rotateY(3deg)',transformStyle:'preserve-3d',boxShadow:'0 25px 50px rgba(139,92,246,0.3)'}}"><div className="p-4 md:p-6 bg-gradient-to-r from-purple-600/20 to-cyan-600/20 border-b border-purple-500/20 flex justify-between items-center"><div><h1 className="text-white font-bold text-xl md:text-2xl">Message Hub</h1><p className="text-xs md:text-sm text-purple-300">{selectedUser?`Chatting with ${selectedUser.name}`:'Select a user to chat'}</p></div><motion.div animate={{rotate:360}}transition={{duration:20,repeat:Infinity,ease:'linear'}}className="hidden lg:block w-10 h-10 rounded-full bg-gradient-to-br from-cyan-400 to-purple-500 opacity-20"/></div><motion.div className="flex-1 overflow-y-auto p-4 md:p-6 space-y-4 scrollbar-thin scrollbar-thumb-purple-500/30 scrollbar-track-transparent" initial={{opacity:0}}animate={{opacity:1}}transition={{delay:.4}}"><motion.div variants={ANIMATIONS.container}initial="hidden"animate="show">{messages.length===0?(<motion.div variants={ANIMATIONS.item}className="h-full flex items-center justify-center"><div className="text-center"><motion.div animate={{y:[0,-10,0]}}transition={{duration:2,repeat:Infinity}}className="text-4xl md:text-5xl mb-4">ğŸ’¬</motion.div><p className="text-gray-400 text-sm md:text-base">No messages yet. Start the conversation!</p></div></motion.div>):( messages.map((msg,idx)=>(<motion.div key={`${msg.id}-${idx}`}variants={ANIMATIONS.item}className={`flex ${msg.sender===auth?.user?.id?'justify-end':'justify-start'} mb-4`}"><motion.div initial={{opacity:0,scale:.8}}animate={{opacity:1,scale:1}}transition={{type:'spring',stiffness:200}}className={`max-w-xs md:max-w-md lg:max-w-lg px-4 py-3 rounded-2xl ${msg.sender===auth?.user?.id?'bg-gradient-to-br from-cyan-500 to-purple-600 text-white rounded-br-none':'bg-slate-700/80 text-gray-100 rounded-bl-none'} backdrop-blur-sm border ${msg.sender===auth?.user?.id?'border-cyan-400/30':'border-purple-500/20'} shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105`}><p className="text-xs md:text-sm font-semibold text-opacity-70 mb-1">{msg.senderName||'User'}</p><p className="text-sm md:text-base break-words">{msg.text}</p><p className="text-xs mt-2 ${msg.sender===auth?.user?.id?'text-cyan-100':'text-gray-400'} opacity-70">{new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute:'2-digit'})}</p></motion.div></motion.div>)))}{ isTyping&&(<motion.div variants={ANIMATIONS.item}className="flex justify-start"><motion.div animate={{opacity:[.5,1,.5]}}transition={{duration:1.5,repeat:Infinity}}className="px-4 py-3 rounded-2xl bg-slate-700/50 text-gray-300 text-sm italic flex gap-1"><span>â—</span><span>â—</span><span>â—</span></motion.div></motion.div>)}</motion.div></motion.div></motion.div><motion.div initial={{y:50,opacity:0}}animate={{y:0,opacity:1}}transition={{delay:.5,duration:.6}}className="p-4 md:p-6 bg-gradient-to-t from-slate-900/50 to-slate-800/50 border-t border-purple-500/20 space-y-3" style={{backdropFilter:'blur(10px)'}}"><div className="flex gap-2 md:gap-3"><input ref={inputRef}type="text"value={input}onChange={handleTyping}onKeyPress={handleKeyPress}placeholder="Type your message here.."className="flex-1 px-4 py-3 bg-slate-700/50 border border-purple-500/30 rounded-xl text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-cyan-400/50 focus:border-cyan-400 transition-all duration-300 text-sm md:text-base"/><motion.button whileHover={{scale:1.05}}whileTap={{scale:.95}}onClick={handleSendMessage}disabled={!input.trim()}className="px-4 md:px-6 py-3 bg-gradient-to-r from-cyan-500 to-purple-600 hover:from-cyan-400 hover:to-purple-500 text-white font-semibold rounded-xl disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-300 text-sm md:text-base min-w-fit">Send</motion.button></div><p className="text-xs text-gray-400 text-center">Press Enter or click Send</p></motion.div></motion.div></motion.div>);};export default ChatWindow;
